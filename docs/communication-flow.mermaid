sequenceDiagram
    participant C as Client Agent
    participant B as Broker
    participant A1 as Analytics Agent 1
    participant A2 as Analytics Agent 2
    participant DB as State Store

    Note over C,DB: Scenario: Complex Data Analysis Task
    
    C->>B: InitiateSession(auth_credentials)
    B->>DB: ValidateAndStore(session)
    DB-->>B: SessionConfirmed
    B-->>C: SessionToken

    C->>B: SubmitAnalyticsTask(large_dataset)
    B->>DB: StoreTask(task_metadata)
    
    par Task Distribution
        B->>A1: TaskAssignment(data_chunk_1)
        B->>A2: TaskAssignment(data_chunk_2)
    end

    loop Processing Updates
        A1-->>B: ProcessingProgress(30%)
        B-->>C: AggregateProgress(A1: 30%)
        A2-->>B: ProcessingProgress(45%)
        B-->>C: AggregateProgress(A1: 30%, A2: 45%)
    end

    Note over A1,A2: Error Occurs in A1
    A1-->>B: ErrorNotification(memory_overflow)
    B->>A1: RecoveryInstruction(reduce_batch)
    
    par Continued Processing
        A1->>B: TaskResult(chunk1_results)
        A2->>B: TaskResult(chunk2_results)
    end

    B->>DB: StoreResults(combined_results)
    B-->>C: AnalysisComplete(results_location)
    
    C->>B: EndSession
    B->>DB: ArchiveSession
